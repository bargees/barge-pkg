From d4478db5b51e11c3bdb65057d182426ed9841a5d Mon Sep 17 00:00:00 2001
From: "A.I" <ailis@paw.zone>
Date: Fri, 10 Aug 2018 10:14:58 -0700
Subject: [PATCH] Fix for CVE-2016-6252

---
 lib/getulong.c      |  9 +++------
 libmisc/idmapping.c |  5 +++++
 libmisc/myname.c    | 14 +-------------
 3 files changed, 9 insertions(+), 19 deletions(-)

diff --git a/lib/getulong.c b/lib/getulong.c
index 61579ca..08d2c1a 100644
--- a/lib/getulong.c
+++ b/lib/getulong.c
@@ -44,22 +44,19 @@
  */
 int getulong (const char *numstr, /*@out@*/unsigned long int *result)
 {
-	long long int val;
+	unsigned long int val;
 	char *endptr;
 
 	errno = 0;
-	val = strtoll (numstr, &endptr, 0);
+	val = strtoul (numstr, &endptr, 0);
 	if (    ('\0' == *numstr)
 	     || ('\0' != *endptr)
 	     || (ERANGE == errno)
-	     /*@+ignoresigns@*/
-	     || (val != (unsigned long int)val)
-	     /*@=ignoresigns@*/
 	   ) {
 		return 0;
 	}
 
-	*result = (unsigned long int)val;
+	*result = val;
 	return 1;
 }
 
diff --git a/libmisc/idmapping.c b/libmisc/idmapping.c
index 714c29e..2698253 100644
--- a/libmisc/idmapping.c
+++ b/libmisc/idmapping.c
@@ -77,6 +77,11 @@ struct map_range *get_map_ranges(int ranges, int argc, char **argv)
 			return NULL;
 		if (!getulong(argv[argidx + 2], &mapping->count))
 			return NULL;
+
+		if (ULONG_MAX - mapping->upper <= mapping->count || ULONG_MAX - mapping->lower <= mapping->count) {
+			fprintf(stderr, _( "%s: subuid overflow detected.\n"), Prog);
+			exit(EXIT_FAILURE);
+		}
 	}
 	return mappings;
 }
diff --git a/libmisc/myname.c b/libmisc/myname.c
index 05efdad..06b732f 100644
--- a/libmisc/myname.c
+++ b/libmisc/myname.c
@@ -44,25 +44,13 @@
 /*@null@*/ /*@only@*/struct passwd *get_my_pwent (void)
 {
 	struct passwd *pw;
-	const char *cp = getlogin ();
 	uid_t ruid = getuid ();
 
-	/*
-	 * Try getlogin() first - if it fails or returns a non-existent
-	 * username, or a username which doesn't match the real UID, fall
-	 * back to getpwuid(getuid()).  This should work reasonably with
-	 * usernames longer than the utmp limit (8 characters), as well as
-	 * shared UIDs - but not both at the same time...
+	/* Do not use getlogin(). Its not suitable for suid binaries.
 	 *
 	 * XXX - when running from su, will return the current user (not
 	 * the original user, like getlogin() does).  Does this matter?
 	 */
-	if ((NULL != cp) && ('\0' != *cp)) {
-		pw = xgetpwnam (cp);
-		if ((NULL != pw) && (pw->pw_uid == ruid)) {
-			return pw;
-		}
-	}
 
 	return xgetpwuid (ruid);
 }
-- 
2.14.1

